{% liquid
  assign product_variants = product.variants | sort: 'price'

  assign cart_value = cart.items_subtotal_price | times: 1.0
  assign free_shipping_threshold = settings.free_shipping_threshold | times: 100.0
  assign variant_price = product.selected_or_first_available_variant.price
  assign cart_value_plus_price = cart_value | plus: variant_price
  assign variant_price_formatted = product.selected_or_first_available_variant.price | money

  if cart_value >= free_shipping_threshold
    assign free_shipping_qualified = true
  elsif cart_value_plus_price >= free_shipping_threshold
    assign add_to_qualify = true
  else
    assign get_closer = true
  endif
%}
{% comment %}
  <div
    x-cloak
    x-show="showStickyAddToCart"
    x-transition:opacity
  >
    <div
      class="sticky-atc"
      data-color-scheme="scheme3"
      @shapes:cart:afteradditem="console.log('updat the free delivery bar')"
    >
      {% render 'sticky-add-to-cart-free-delivery',
        free_shipping_qualified: free_shipping_qualified,
        add_to_qualify: add_to_qualify,
        get_closer: get_closer,
        variant_price: variant_price,
        cart_value: cart_value,
        free_shipping_threshold: free_shipping_threshold
      %}

      {% form 'product',
        product,
        class: 'shopify-product-form',
        id: 'sticky-atc-form',
        data-product-form: '',
        x-ref: 'stickyForm'
      %}
        <div class="sticky-atc__form">
          {% if product.options.size > 1 %}
            <div
              class="nx:grid nx:grid-cols-2 nx:gap-2.5 optionSelectors"
              x-data="optionSelectors({ variants: {{ product_variants | json | escape }}, optionNames: {{ product.options | json | escape }}, initialOptions: {{ product.selected_or_first_available_variant.options | json | escape }}, selectedVariantId: {{ product.selected_or_first_available_variant.id }} })"
            >
              {% for option in product.options_with_values %}
                <label class="nx:flex nx:flex-col nx:w-full nx:gap-1">
                  <span>{{ option.name }}</span>
                  <select
                    name="{{ option.name }}"
                    id="{{ option.name |  handleize }}"
                    x-data="
                      {
                        optionValueId: null,

                        init() {
                          this.optionValueId = $root.querySelector('option:checked').dataset.optionValueId;
                        },

                        handleChange(e) {
                          this.optionValueId = $root.querySelector('option:checked').dataset.optionValueId;
                          $nextTick(() => { updateOptionValues(e) });
                        }
                      }
                    "
                    @change="handleChange"
                    :data-option-value-id="optionValueId"
                  >
                    {% for value in option.values %}
                      <option
                        value="{{ value }}"
                        data-option-value-id="{{ value.id }}"
                        {% if value.selected %}
                          selected
                        {% endif %}
                      >
                        {{ value }}
                      </option>
                    {% endfor %}
                  </select>
                </label>
              {% endfor %}
            </div>
          {% else %}
            <div class="sticky-atc__variants" @change="updateVariant($event.target.value)">
              {% for variant in product_variants %}
                {% if variant.available %}
                  <label for="Sticky-Cart-Option-{{ variant.id }}" class="sticky-atc__variant">
                    <input
                      type="radio"
                      name="variantId"
                      value="{{ variant.id }}"
                      id="Sticky-Cart-Option-{{ variant.id }}"
                      {% if variant == product.selected_or_first_available_variant %}
                        checked
                      {% endif %}
                      data-price="{{ variant.price }}"
                      data-available="true"
                    >
                    <span class="sticky-atc__variant-title">{{ variant.title }}</span>
                    <span class="sticky-atc__variant-price-per-item" x-ref="test">
                      {% assign money_string = variant.unit_price | money %}
                      {{-
                        'products.product.sticky_add_to_cart.per_item_price'
                        | t: price: money_string, unit: product.metafields.custom.unit_price_type
                      -}}
                    </span>
                  </label>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <div class="sticky-atc__buttons">
            <button
              type="submit"
              class="nx:bg-bright-pink nx:text-white nx:flex nx:items-center nx:justify-center nx:gap-2.5 nx:p-2.5 nx:rounded-lg nx:w-full"
            >
              <span class="nx:font-display nx:text-lg nx:leading-none" x-text="addingToCart ? 'Adding...' : 'Add to cart'"
                >Add to cart</span
              >
              <span class="nx:font-bold nx:text-sm nx:leading-none nx:opacity-80 nx:translate-y-0.5">
                {{ product.selected_or_first_available_variant.price | money }}
              </span>
            </button>
            {{ form | payment_button }}
          </div>
          {% # render 'pdp-delivery-by', product: product %}
        </div>
      {% endform %}
    </div>
  </div>
{% endcomment %}

{% stylesheet %}
  .sticky-atc {
    --border-and-text-colour: #3f062a;
    --color-scheme-secondary-background: 255, 255, 255 !important;
    --color-scheme-secondary-text: 63, 6, 42 !important;
    --color-button-shadow: var(--color-scheme-accent-1) !important;
    display: grid;
    gap: 1rem;
    position: fixed;
    bottom: 0;
    left: 0;
    z-index: 1999999;
    padding-inline: 0.75rem;
    padding-block: 1.5rem;
    width: 100%;
    background-color: white;
    color: var(--border-and-text-colour);
    border: 3px solid var(--border-and-text-colour);
    border-bottom: 0px;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
    filter: drop-shadow(0 -4px 4px rgba(0, 0, 0, 0.15));
  }

  .sticky-atc__free-delivery-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
  }
  .sticky-atc__bar {
    width: 20rem;
    height: 0.5rem;
    border-radius: 999rem;
    background-color: #ffeef9;
    position: relative;
    overflow: clip;
  }

  .sticky-atc__bar-inner {
    position: absolute;
    top: 0;
    left: 0;
    background-color: #3f062a;
    width: 100%;
    transform-origin: left center;
    transform: scaleX(0);
    transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1);
    will-change: transform;
    border-radius: calc(infinity * 1px);
    height: 100%;
  }

  .sticky-atc__free-delivery-text {
    font-weight: 600;
    text-align: center;
  }

  .sticky-atc__form {
    display: grid;
    gap: 0.625rem;
  }

  .sticky-atc__variants {
    display: flex;
    gap: 0.625rem;
    /* row-gap: 0.325rem; */
    flex-wrap: wrap;
    justify-content: center;
  }

  .sticky-atc__variant {
    --text-colour: #3f062a;
    --background-color: #f2f2f2;
    --price-per-item-color: rgba(0, 0, 0, 0.3);

    display: flex;
    flex-direction: column;
    flex-grow: 1;
    flex-basis: calc(33% - 0.625rem);
    text-align: center;
    padding-inline: 1rem;
    padding-block: 0.5rem;
    border-radius: 999rem;
    text-transform: uppercase;
    justify-content: center;
    white-space: nowrap;

    background-color: var(--background-color);
    color: var(--text-colour);

    input {
      display: none;
    }

    &:has(:checked) {
      --text-colour: #eeeeee;
      --background-color: #3f062a;
      --price-per-item-color: rgba(255, 255, 255, 0.6);
    }
  }

  .sticky-atc__variant-title {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .sticky-atc__variant-price-per-item {
    font-size: 0.75rem;
    color: var(--price-per-item-color);
  }

  .sticky-atc__buttons {
    display: flex;
    align-items: start;
    gap: 0.625rem;
  }

  .add-to-cart-btn .push-btn__surface {
    font-weight: 700;
  }

  .add-to-cart-btn__price {
    font-weight: 600;
    opacity: 60%;
  }

  @media (width >= 990px) {
    .sticky-atc {
      display: none;
    }
  }
{% endstylesheet %}
