{% liquid
  assign current_variant = product.selected_or_first_available_variant
%}

<div
  class="nx:container nx:max-w-7xl nx:mx-auto nx:py-20 nx:px-4 nx:font-sans"
  id="{{ section.id }}"
  x-data="addToCartForm"
  x-ref="addToCartForm"
  @submit.prevent="handleSubmit"
>
  <div class="grid nx:grid-cols-1 nx:lg:grid-cols-2 nx:gap-9 nx:lg:gap-18">
    <div>
      {% render 'pdp-images', product: product %}
    </div>
    {% form 'product', product, x-ref: 'productForm' %}
      <div class="nx:grid nx:gap-6">
        {% content_for 'blocks' %}
      </div>
    {% endform %}
  </div>
</div>

{% javascript %}
  document.addEventListener('alpine:init', () => {
    Alpine.data('addToCartForm', () => ({
      addingToCart: false,
      showStickyAddToCart: true,
      currentVariantId: null,

      init() {
        this.sectionId = this.$el.id;
        this.currentVariantId = document.querySelector("input[name='id']:checked.value");
      },
      async updateVariant(variantId) {
        this.currentVariantId = variantId;
        const res = await fetch(window.location.pathname + `?variant=${variantId}` + `&section_id=${this.sectionId}`);
        const text = await res.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;

        const newBuyBox = tempDiv.querySelector('[x-ref="productForm"]').innerHTML;
        this.$refs.productForm.innerHTML = newBuyBox;

        // Reflect the selected variant in the URL without reloading
        if (variantId) {
          const url = new URL(window.location.href);

          url.searchParams.set('variant', variantId);
          window.history.replaceState({}, '', url.toString());
        }
      },
      async updateOptionValues(e) {
        const optionValueSelectors = e.target.closest('.optionSelectors');

        const selectedOptionValues = Array.from(
          optionValueSelectors.querySelectorAll('input[type="radio"]:checked, select')
        ).map(({ dataset }) => dataset.optionValueId);

        const params = selectedOptionValues.length > 0 ? `&option_values=${selectedOptionValues.join(',')}` : '';

        const res = await fetch(`${window.location.href}?section_id=${this.sectionId}${params}`);
        const text = await res.text();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;

        const newBuyBox = tempDiv.querySelector('[x-ref="productForm"]').innerHTML;
        this.$refs.productForm.innerHTML = newBuyBox;
      },
      async handleSubmit() {
        const formData = new FormData(this.$refs.productForm);
        const formId = this.$refs.productForm.getAttribute('id');

        this.addingToCart = true;

        try {
          const res = await fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            body: formData,
          });
          const data = await res.json().catch(() => null);
          if (!res.ok || (data && data.status)) return;

          // Fire theme cart add event (used by ModalCart to open the drawer)
          document.body.dispatchEvent(
            new CustomEvent('shapes:cart:afteradditem', {
              bubbles: true,
              detail: { response: data, sourceId: formId },
            })
          );

          this.updateVariant(this.currentVariantId);

          // Use existing theme events to refresh and open the cart drawer
          document.dispatchEvent(new CustomEvent('theme:update:cart'));
          document.dispatchEvent(new CustomEvent('theme:open:cart-drawer'));
        } catch (_) {
          // Silently ignore errors
          return;
        }

        this.addingToCart = false;
      },
    }));
  });
{% endjavascript %}

{% schema %}
{
  "name": "Product buy box",
  "class": "nx:bg-light-pink nx:text-plum",
  "settings": [],
  "blocks": [
    { "type": "@theme" },
    { "type": "_product-title" },
    { "type": "_pdp-features" },
    { "type": "_pdp-price" },
    { "type": "_pdp-options" },
    { "type": "_pdp-collapsible-group" },
    { "type": "_pdp-add-to-cart" },
    { "type": "_sticky-cart" }
  ],
  "presets": [
    {
      "name": "Product buy box",
      "category": "Products"
    }
  ]
}
{% endschema %}
